<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin â€” Rifas El Menor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --purple:#7C3AED; --purple-light:#A78BFA; --purple-dark:#5B21B6;
      --sky:#0EA5E9; --teal:#14B8A6;
      --bg:#0F0A1E; --surface:#1A1035; --surface2:#231448;
      --text:#F1F0FF; --text-muted:#9B8EC4;
    }
    * { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
    body { font-family:'Nunito',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
    body::before {
      content:''; position:fixed; inset:0;
      background:
        radial-gradient(ellipse at 20%   0%, rgba(124,58,237,.2)  0%, transparent 60%),
        radial-gradient(ellipse at 80% 100%, rgba(20,184,166,.15) 0%, transparent 60%);
      pointer-events:none; z-index:0;
    }
    .content { position:relative; z-index:1; }

    .card { background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:16px; }
    .badge { padding:4px 10px; border-radius:8px; font-size:11px; font-weight:800; display:inline-block; }
    .badge-pendiente { background:rgba(251,191,36,.2);  color:#FBB124; border:1px solid rgba(251,191,36,.4); }
    .badge-aprobado  { background:rgba(20,184,166,.2);  color:#5EEAD4; border:1px solid rgba(20,184,166,.4); }
    .badge-rechazado { background:rgba(239,68,68,.2);   color:#FCA5A5; border:1px solid rgba(239,68,68,.4);  }

    .btn-approve {
      background:linear-gradient(135deg,#14B8A6,#0EA5E9);
      color:#fff; font-weight:800; border:none; border-radius:10px;
      cursor:pointer; font-family:'Nunito',sans-serif; transition:transform .15s;
    }
    .btn-approve:active { transform:scale(.96); }
    .btn-reject {
      background:linear-gradient(135deg,#EF4444,#DC2626);
      color:#fff; font-weight:800; border:none; border-radius:10px;
      cursor:pointer; font-family:'Nunito',sans-serif; transition:transform .15s;
    }
    .btn-reject:active { transform:scale(.96); }
    .btn-reset {
      background:linear-gradient(135deg,#7F1D1D,#DC2626); color:#fff; font-weight:900;
      border:2px solid rgba(239,68,68,.5); border-radius:16px; cursor:pointer;
      font-family:'Nunito',sans-serif; transition:transform .15s, box-shadow .15s;
      box-shadow:0 4px 24px rgba(220,38,38,.4);
    }
    .btn-reset:active { transform:scale(.97); }

    /* â˜… BotÃ³n Editar PÃ¡gina Principal */
    .btn-edit-landing {
      background:linear-gradient(135deg,var(--purple),var(--sky));
      color:#fff; font-weight:800; border:none; border-radius:12px;
      cursor:pointer; font-family:'Nunito',sans-serif; transition:transform .15s;
      box-shadow:0 4px 20px rgba(124,58,237,.4); font-size:13px;
    }
    .btn-edit-landing:active { transform:scale(.97); }

    /* â˜… Panel de ediciÃ³n de landing */
    .landing-edit-panel {
      background:linear-gradient(135deg,rgba(124,58,237,.1),rgba(14,165,233,.07));
      border:1px solid rgba(124,58,237,.35); border-radius:18px; padding:16px;
      margin:0 16px 16px;
    }

    .login-screen { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
    .login-card {
      background:var(--surface); border:1px solid rgba(124,58,237,.3);
      border-radius:24px; padding:32px 24px; width:100%; max-width:360px;
      box-shadow:0 20px 60px rgba(124,58,237,.2);
    }
    .form-input {
      background:rgba(255,255,255,.06); border:1.5px solid rgba(255,255,255,.12);
      border-radius:12px; color:#fff; outline:none; width:100%;
      font-family:'Nunito',sans-serif; padding:12px 16px; transition:border-color .2s;
    }
    .form-input:focus { border-color:var(--purple-light); }
    .form-input::placeholder { color:var(--text-muted); }
    .form-textarea {
      background:rgba(255,255,255,.06); border:1.5px solid rgba(255,255,255,.12);
      border-radius:12px; color:#fff; outline:none; width:100%;
      font-family:'Nunito',sans-serif; padding:12px 16px; transition:border-color .2s;
      resize:vertical; min-height:80px;
    }
    .form-textarea:focus { border-color:var(--purple-light); }
    .form-textarea::placeholder { color:var(--text-muted); }
    .btn-primary {
      background:linear-gradient(135deg,var(--purple),var(--sky));
      color:#fff; font-weight:800; border:none; border-radius:14px;
      cursor:pointer; width:100%; padding:14px; font-size:15px;
      font-family:'Nunito',sans-serif; transition:transform .15s;
    }
    .btn-primary:active { transform:scale(.97); }

    .num-chip {
      background:rgba(124,58,237,.25); border:1px solid rgba(167,139,250,.3);
      border-radius:6px; padding:2px 8px; font-size:11px; font-weight:700;
      color:var(--purple-light); display:inline-block; margin:2px;
    }
    .capture-img {
      width:100%; max-height:200px; object-fit:cover;
      border-radius:10px; border:1px solid rgba(255,255,255,.1); cursor:pointer;
    }
    .tab-btn {
      padding:8px 16px; border-radius:10px; font-weight:700; font-size:13px;
      border:1.5px solid rgba(255,255,255,.12); background:transparent;
      color:var(--text-muted); cursor:pointer; font-family:'Nunito',sans-serif;
      transition:all .15s; white-space:nowrap;
    }
    .tab-btn.active { background:var(--purple); border-color:var(--purple-light); color:#fff; }

    .winner-box {
      background:linear-gradient(135deg,rgba(250,204,21,.12) 0%,rgba(234,179,8,.06) 100%);
      border:1px solid rgba(250,204,21,.35); border-radius:18px;
    }
    .winner-result {
      background:linear-gradient(135deg,rgba(20,184,166,.12) 0%,rgba(14,165,233,.08) 100%);
      border:1px solid rgba(20,184,166,.4); border-radius:14px;
    }
    .btn-winner-search {
      background:linear-gradient(135deg,#EAB308,#F59E0B);
      color:#000; font-weight:900; border:none; border-radius:12px;
      cursor:pointer; font-family:'Nunito',sans-serif; transition:transform .15s;
      box-shadow:0 4px 20px rgba(234,179,8,.4);
    }
    .btn-winner-search:active { transform:scale(.97); }

    .danger-zone { background:rgba(127,29,29,.15); border:1px solid rgba(239,68,68,.25); border-radius:18px; }

    .copy-btn {
      background:none; border:none; cursor:pointer; padding:1px 4px;
      color:#5EEAD4; font-size:13px; opacity:.6;
      transition:opacity .15s, transform .15s; vertical-align:middle; line-height:1;
    }
    .copy-btn:active { opacity:1; transform:scale(.82); }

    .toast {
      position:fixed; top:20px; left:50%; transform:translateX(-50%);
      background:var(--surface2); border:1px solid rgba(255,255,255,.15);
      border-radius:14px; padding:12px 20px; font-weight:700; font-size:14px;
      z-index:9999; white-space:nowrap; animation:toastIn .3s ease;
      box-shadow:0 8px 30px rgba(0,0,0,.5); max-width:90vw; text-align:center;
    }
    @keyframes toastIn {
      from{ opacity:0; transform:translateX(-50%) translateY(-10px) }
      to  { opacity:1; transform:translateX(-50%) translateY(0) }
    }
    ::-webkit-scrollbar{ width:4px }
    ::-webkit-scrollbar-thumb{ background:rgba(124,58,237,.4); border-radius:4px }
  </style>
</head>
<body>
<div class="content">

  <!-- â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â• -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <div class="text-center mb-6">
        <div class="text-4xl mb-2">ğŸ”</div>
        <h1 class="text-xl font-black">Panel Admin</h1>
        <p class="text-sm text-gray-400">Rifas El Menor</p>
      </div>
      <div class="space-y-3">
        <input type="password" id="loginPass" class="form-input" placeholder="ContraseÃ±a" />
        <button onclick="doLogin()" class="btn-primary">Ingresar â†’</button>
      </div>
      <p class="text-center text-xs text-gray-500 mt-4">
        <a href="landing.html" class="text-purple-400">â† Volver a la rifa</a>
      </p>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• PANEL â•â•â•â•â•â•â•â•â•â• -->
  <div id="adminPanel" style="display:none">

    <!-- HEADER FIJO -->
    <div style="background:linear-gradient(135deg,#5B21B6,#1e0a4e);
      border-bottom:1px solid rgba(124,58,237,.4);"
      class="px-4 py-3 sticky top-0 z-50">
      <div class="flex items-center justify-between">
        <div>
          <div style="font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:18px;">
            âš™ï¸ Panel Admin
          </div>
          <div class="text-xs text-purple-300">Rifas El Menor</div>
        </div>
        <div class="flex items-center gap-2">
          <!-- â˜… BOTÃ“N EDITAR PÃGINA PRINCIPAL -->
          <button onclick="toggleLandingPanel()" class="btn-edit-landing px-3 py-2">
            ğŸ–¼ï¸ Editar PÃ¡gina Principal
          </button>
          <button onclick="doLogout()"
            class="text-xs text-gray-400 border border-white/20 rounded-lg px-3 py-1.5">
            Salir
          </button>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-2 mt-3">
        <div class="card p-2 text-center">
          <div class="text-xs text-gray-400">Pendientes</div>
          <div class="text-lg font-black text-yellow-400" id="sPendientes">0</div>
        </div>
        <div class="card p-2 text-center">
          <div class="text-xs text-gray-400">Aprobados</div>
          <div class="text-lg font-black text-teal-400" id="sAprobados">0</div>
        </div>
        <div class="card p-2 text-center">
          <div class="text-xs text-gray-400">Rechazados</div>
          <div class="text-lg font-black text-red-400" id="sRechazados">0</div>
        </div>
      </div>
    </div>

    <!-- â˜… PANEL EDITAR PÃGINA PRINCIPAL (se muestra/oculta) -->
    <div id="landingEditPanel" class="landing-edit-panel" style="display:none; margin-top:12px;">
      <div class="flex items-center gap-2 mb-3">
        <span class="text-2xl">ğŸ–¼ï¸</span>
        <div>
          <div class="font-black text-purple-300" style="font-family:'Space Grotesk',sans-serif;">
            Editar PÃ¡gina Principal
          </div>
          <div class="text-xs text-gray-400">Flyer y mensaje que ven los usuarios al entrar</div>
        </div>
      </div>

      <div class="space-y-3">
        <!-- Subir flyer -->
        <div>
          <label class="text-xs font-bold text-gray-300 block mb-1">ğŸ“· Subir Flyer (imagen del sorteo)</label>
          <label style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px;
            border:2px dashed rgba(167,139,250,.4);border-radius:12px;
            background:rgba(124,58,237,.06);cursor:pointer;" for="flyerUpload">
            <div class="text-3xl" id="flyerUploadIcon">ğŸ“</div>
            <div class="text-sm text-gray-400 text-center" id="flyerUploadText">
              Toca para seleccionar el flyer
            </div>
            <input type="file" id="flyerUpload" accept="image/*" class="hidden"
              onchange="previewFlyer(this)" />
          </label>
          <img id="flyerPreview" style="display:none;width:100%;margin-top:8px;
            border-radius:10px;max-height:160px;object-fit:cover;" />
        </div>

        <!-- Mensaje de texto -->
        <div>
          <label class="text-xs font-bold text-gray-300 block mb-1">ğŸ“ Mensaje para los usuarios</label>
          <textarea id="landingMsgInput" class="form-textarea"
            placeholder="Ej: Rifas para el dÃ­a tal, aprovecha y participa. Â¡El premio es increÃ­ble!"></textarea>
        </div>

        <!-- Botones guardar / cancelar -->
        <div class="flex gap-2">
          <button onclick="saveLandingContent()"
            style="flex:1;padding:12px;border:none;border-radius:12px;cursor:pointer;
              font-family:'Nunito',sans-serif;font-weight:900;font-size:14px;color:#fff;
              background:linear-gradient(135deg,#14B8A6,#0EA5E9);">
            ğŸ’¾ Guardar cambios
          </button>
          <button onclick="toggleLandingPanel()"
            style="padding:12px 16px;border:1.5px solid rgba(255,255,255,.2);border-radius:12px;
              background:transparent;color:var(--text-muted);font-weight:700;cursor:pointer;
              font-family:'Nunito',sans-serif;">
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <!-- BUSCADOR DE GANADOR -->
    <div class="px-4 pt-4 pb-2">
      <div class="winner-box p-4">
        <div class="flex items-center gap-2 mb-3">
          <span class="text-2xl">ğŸ†</span>
          <div>
            <div style="font-family:'Space Grotesk',sans-serif;" class="font-bold text-yellow-300">
              Buscar Ganador
            </div>
            <div class="text-xs text-gray-400">Ingresa el nÃºmero premiado de la loterÃ­a</div>
          </div>
        </div>
        <div class="flex gap-2 mb-3">
          <input type="text" id="winnerInput"
            class="form-input flex-1 text-center text-xl font-black"
            placeholder="0000" maxlength="4" inputmode="numeric"
            style="letter-spacing:.2em;" />
          <button onclick="buscarGanador()" id="btnWinner" class="btn-winner-search px-5 py-2 text-sm">
            ğŸ” Buscar
          </button>
        </div>
        <div id="winnerResult"></div>
      </div>
    </div>

    <!-- TABS -->
    <div class="px-4 py-3 flex gap-2 overflow-x-auto">
      <button class="tab-btn active" onclick="filterPedidos('todos',this)">Todos</button>
      <button class="tab-btn" onclick="filterPedidos('pendiente',this)">â³ Pendientes</button>
      <button class="tab-btn" onclick="filterPedidos('aprobado',this)">âœ… Aprobados</button>
      <button class="tab-btn" onclick="filterPedidos('rechazado',this)">âŒ Rechazados</button>
    </div>

    <!-- BÃšSQUEDA -->
    <div class="px-4 mb-3">
      <input type="text" id="adminSearch" class="form-input"
        placeholder="ğŸ” Buscar por nombre, cÃ©dula..."
        oninput="searchPedidos(this.value)" />
    </div>

    <!-- LISTA DE PEDIDOS -->
    <div id="pedidosList" class="px-4 space-y-3">
      <div class="text-center py-8 text-gray-500">â³ Cargando pedidos...</div>
    </div>

    <!-- ZONA DE PELIGRO -->
    <div class="px-4 py-6">
      <div class="danger-zone p-4">
        <div class="text-xs font-black text-red-400 mb-1 tracking-widest">âš ï¸ ZONA DE PELIGRO</div>
        <p class="text-xs text-gray-400 mb-4">
          Borra TODOS los pedidos y tickets para iniciar una nueva jornada.
          Esta acciÃ³n es <strong class="text-red-400">irreversible</strong>.
          Se solicitarÃ¡ una palabra clave de confirmaciÃ³n.
        </p>
        <button onclick="reiniciarRifa()" class="btn-reset w-full py-4 text-base">
          ğŸš¨ Reiniciar Rifa (Nueva Jornada)
        </button>
      </div>
    </div>

  </div><!-- /adminPanel -->
</div><!-- /content -->

<!-- IMAGE MODAL -->
<div id="imgModal"
  style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);
    z-index:9999;align-items:center;justify-content:center;"
  onclick="this.style.display='none'">
  <img id="imgModalSrc" style="max-width:95%;max-height:90vh;border-radius:12px;" />
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<script>
// ============================================================
//  CONTRASEÃ‘A ADMIN  â† cÃ¡mbiala aquÃ­
// ============================================================
const ADMIN_PASSWORD = 'rifas2024';

let allPedidos    = [];
let currentFilter = 'todos';
let flyerFile     = null; // archivo a subir

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOGIN / LOGOUT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doLogin() {
  if (document.getElementById('loginPass').value === ADMIN_PASSWORD) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('adminPanel').style.display  = 'block';
    loadPedidos();
    loadLandingConfig(); // carga datos existentes del panel landing
  } else {
    showToast('âŒ ContraseÃ±a incorrecta');
  }
}
document.getElementById('loginPass').addEventListener('keypress', e => {
  if (e.key === 'Enter') doLogin();
});
function doLogout() {
  document.getElementById('adminPanel').style.display  = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginPass').value = '';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CARGAR PEDIDOS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPedidos() {
  try {
    const { data, error } = await db
      .from('pedidos').select('*').order('created_at', { ascending:false });
    if (error) throw error;
    allPedidos = data || [];
    updateStats();
    renderPedidos(allPedidos);
  } catch(err) {
    console.error(err);
    document.getElementById('pedidosList').innerHTML =
      '<div class="text-center py-8 text-red-400">âŒ Error cargando pedidos</div>';
  }
}

function updateStats() {
  document.getElementById('sPendientes').textContent = allPedidos.filter(p => p.estado === 'pendiente').length;
  document.getElementById('sAprobados').textContent  = allPedidos.filter(p => p.estado === 'aprobado').length;
  document.getElementById('sRechazados').textContent = allPedidos.filter(p => p.estado === 'rechazado').length;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RENDERIZAR PEDIDOS â€” con botones copiar
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPedidos(pedidos) {
  const list = document.getElementById('pedidosList');
  if (!pedidos.length) {
    list.innerHTML = '<div class="text-center py-8 text-gray-500">No hay pedidos aquÃ­</div>';
    return;
  }
  list.innerHTML = pedidos.map(p => {
    const waNum = '58' + p.whatsapp.replace(/\D/g,'').replace(/^0/,'');
    return `
    <div class="card p-4" id="pedido-${p.id}">
      <div class="flex items-start justify-between mb-3">
        <div>
          <div class="font-black text-base">${p.nombre}</div>
          <div class="text-xs text-gray-400 mt-0.5">
            ${new Date(p.created_at).toLocaleString('es-VE')}
          </div>
        </div>
        <span class="badge badge-${p.estado}">${getBadgeLabel(p.estado)}</span>
      </div>

      <div class="grid grid-cols-2 gap-2 text-sm mb-3">
        <div>
          <span class="text-gray-400 text-xs block">CÃ©dula</span>
          <span class="font-bold flex items-center gap-0.5">
            ${p.cedula}
            <button class="copy-btn"
              onclick="adminCopy('${p.cedula.replace(/'/g,"\\'")}','CÃ©dula copiada âœ…')"
              title="Copiar cÃ©dula">ğŸ“‹</button>
          </span>
        </div>
        <div>
          <span class="text-gray-400 text-xs block">WhatsApp</span>
          <span class="font-bold text-teal-400 flex items-center gap-0.5">
            <a href="https://wa.me/${waNum}" target="_blank">${p.whatsapp}</a>
            <button class="copy-btn"
              onclick="adminCopy('${p.whatsapp}','WhatsApp copiado âœ…')"
              title="Copiar WhatsApp">ğŸ“‹</button>
          </span>
        </div>
        <div>
          <span class="text-gray-400 text-xs block">Boletos</span>
          <span class="font-bold">${p.numeros ? p.numeros.length : 0}</span>
        </div>
        <div>
          <span class="text-gray-400 text-xs block">Total</span>
          <span class="font-black text-teal-300">Bs. ${p.total}</span>
        </div>
        ${p.ref_comprobante ? `
        <div style="grid-column:span 2">
          <span class="text-gray-400 text-xs block">Ref. comprobante</span>
          <span class="font-black text-yellow-300">...${p.ref_comprobante}
            <button class="copy-btn"
              onclick="adminCopy('${p.ref_comprobante}','Referencia copiada âœ…')"
              title="Copiar referencia">ğŸ“‹</button>
          </span>
        </div>` : ''}
      </div>

      <div class="mb-3">
        <div class="text-xs font-bold text-gray-400 mb-1.5">NÃšMEROS:</div>
        <div class="flex flex-wrap">
          ${(p.numeros || []).map(n => `<span class="num-chip">${String(n).padStart(4,'0')}</span>`).join('')}
        </div>
      </div>

      ${p.capture_url ? `
        <div class="mb-3">
          <div class="text-xs font-bold text-gray-400 mb-1.5">COMPROBANTE:</div>
          <img src="${p.capture_url}" class="capture-img"
            onclick="openImgModal('${p.capture_url}')" />
        </div>` : ''}

      ${p.estado === 'pendiente' ? `
        <div class="flex gap-2 mt-3">
          <button class="btn-approve flex-1 py-2.5 text-sm"
            onclick="approveOrder('${p.id}')">âœ… Aprobar</button>
          <button class="btn-reject flex-1 py-2.5 text-sm"
            onclick="rejectOrder('${p.id}')">âŒ Rechazar</button>
        </div>` : `
        <div class="text-xs text-center text-gray-500 mt-2">
          ${p.estado === 'aprobado'
            ? 'âœ… NÃºmeros vendidos confirmados'
            : 'âŒ Pedido rechazado â€” nÃºmeros liberados'}
        </div>`}
    </div>`;
  }).join('');
}

function getBadgeLabel(e) {
  return { pendiente:'â³ Pendiente', aprobado:'âœ… Aprobado', rechazado:'âŒ Rechazado' }[e] || e;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// APROBAR / RECHAZAR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function approveOrder(pedidoId) {
  if (!confirm('Â¿Aprobar este pedido? Los nÃºmeros se marcarÃ¡n como VENDIDOS.')) return;
  try {
    const { error:e1 } = await db.from('pedidos').update({estado:'aprobado'}).eq('id',pedidoId);
    if (e1) throw e1;
    const { error:e2 } = await db.from('tickets').update({estado:'vendido'}).eq('pedido_id',pedidoId);
    if (e2) throw e2;
    showToast('âœ… Pedido aprobado. NÃºmeros vendidos.');
    await loadPedidos();
  } catch(err) { console.error(err); showToast('âŒ Error al aprobar'); }
}

async function rejectOrder(pedidoId) {
  if (!confirm('Â¿Rechazar este pedido? Los nÃºmeros quedarÃ¡n DISPONIBLES de nuevo.')) return;
  try {
    const { error:e1 } = await db.from('pedidos').update({estado:'rechazado'}).eq('id',pedidoId);
    if (e1) throw e1;
    const { error:e2 } = await db.from('tickets').delete().eq('pedido_id',pedidoId);
    if (e2) throw e2;
    showToast('ğŸ—‘ï¸ Pedido rechazado. NÃºmeros liberados.');
    await loadPedidos();
  } catch(err) { console.error(err); showToast('âŒ Error al rechazar'); }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FILTROS & BÃšSQUEDA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterPedidos(estado, btn) {
  currentFilter = estado;
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  applyFilter();
}
function searchPedidos(q) { applyFilter(q); }
function applyFilter(query = document.getElementById('adminSearch').value) {
  let f = allPedidos;
  if (currentFilter !== 'todos') f = f.filter(p => p.estado === currentFilter);
  if (query.trim()) {
    const q = query.toLowerCase();
    f = f.filter(p =>
      p.nombre.toLowerCase().includes(q) ||
      p.cedula.toLowerCase().includes(q) ||
      p.whatsapp.includes(q)
    );
  }
  renderPedidos(f);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// IMAGEN MODAL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openImgModal(url) {
  document.getElementById('imgModalSrc').src = url;
  document.getElementById('imgModal').style.display = 'flex';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// COPIAR AL PORTAPAPELES (admin)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function adminCopy(text, toastMsg) {
  navigator.clipboard.writeText(text)
    .then(() => showToast(toastMsg, 1800))
    .catch(() => {
      const ta = document.createElement('textarea');
      ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
      document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); document.body.removeChild(ta);
      showToast(toastMsg, 1800);
    });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BUSCAR GANADOR
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('winnerInput').addEventListener('keypress', e => {
  if (e.key === 'Enter') buscarGanador();
});

async function buscarGanador() {
  const raw = document.getElementById('winnerInput').value.trim();
  if (!raw) { showToast('âš ï¸ Escribe el nÃºmero ganador', 2000); return; }
  const num = parseInt(raw);
  if (isNaN(num) || num < 0 || num > 9999) { showToast('âš ï¸ NÃºmero invÃ¡lido (0000-9999)', 2000); return; }

  const btn = document.getElementById('btnWinner');
  const resultDiv = document.getElementById('winnerResult');
  btn.textContent = 'â³'; btn.disabled = true;
  resultDiv.innerHTML = '<div class="text-center py-3 text-gray-400 text-sm">Buscando...</div>';

  try {
    const { data:ticketData, error:tErr } = await db
      .from('tickets').select('numero,estado,pedido_id').eq('numero',num).maybeSingle();
    if (tErr) throw tErr;

    if (!ticketData || !ticketData.pedido_id) {
      resultDiv.innerHTML = `
        <div class="text-center py-4">
          <div class="text-3xl mb-2">ğŸ«</div>
          <p class="font-bold text-gray-300">
            El nÃºmero <strong class="text-yellow-300">${String(num).padStart(4,'0')}</strong>
            no tiene dueÃ±o registrado.
          </p>
          <p class="text-xs text-gray-500 mt-1">EstÃ¡ disponible o no fue vendido.</p>
        </div>`;
    } else {
      const { data:pedido, error:pErr } = await db
        .from('pedidos').select('*').eq('id',ticketData.pedido_id).single();
      if (pErr) throw pErr;

      const waNum  = '58' + pedido.whatsapp.replace(/\D/g,'').replace(/^0/,'');
      const waMsg  = encodeURIComponent(
        `Â¡Hola ${pedido.nombre}! ğŸ‰ El nÃºmero *${String(num).padStart(4,'0')}* que compraste en Rifas El Menor ES EL GANADOR. Â¡Felicidades! ğŸŸï¸`
      );
      const waLink = `https://wa.me/${waNum}?text=${waMsg}`;
      const estadoBadge = ticketData.estado === 'vendido'
        ? '<span style="color:#5EEAD4;font-weight:900;">âœ… VENDIDO / CONFIRMADO</span>'
        : '<span style="color:#FBB124;font-weight:900;">â³ RESERVADO (pendiente)</span>';

      resultDiv.innerHTML = `
        <div class="winner-result p-4">
          <div class="text-center mb-3">
            <div class="text-3xl">ğŸŠ</div>
            <div class="text-yellow-300 font-black text-lg mt-1">Â¡GANADOR ENCONTRADO!</div>
            <div class="text-2xl font-black mt-1" style="letter-spacing:.2em;">
              ${String(num).padStart(4,'0')}
            </div>
            <div class="text-xs mt-1">${estadoBadge}</div>
          </div>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-400">ğŸ‘¤ Nombre:</span>
              <span class="font-black">${pedido.nombre}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400">ğŸªª CÃ©dula:</span>
              <span class="font-bold flex items-center gap-0.5">
                ${pedido.cedula}
                <button class="copy-btn"
                  onclick="adminCopy('${pedido.cedula.replace(/'/g,"\\'")}','CÃ©dula copiada âœ…')"
                  title="Copiar">ğŸ“‹</button>
              </span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-gray-400">ğŸ“± WhatsApp:</span>
              <span class="font-bold text-teal-300 flex items-center gap-0.5">
                ${pedido.whatsapp}
                <button class="copy-btn"
                  onclick="adminCopy('${pedido.whatsapp}','WhatsApp copiado âœ…')"
                  title="Copiar">ğŸ“‹</button>
              </span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-400">ğŸŸï¸ Total boletos:</span>
              <span class="font-bold">${(pedido.numeros||[]).length}</span>
            </div>
          </div>
          <div class="mt-3">
            <div class="text-xs text-gray-400 mb-1 font-bold">TODOS SUS NÃšMEROS:</div>
            <div class="flex flex-wrap">
              ${(pedido.numeros||[]).map(n =>
                n === num
                  ? `<span class="num-chip" style="background:rgba(250,204,21,.3);
                      border-color:rgba(250,204,21,.6);color:#FDE047;">
                      ${String(n).padStart(4,'0')}</span>`
                  : `<span class="num-chip">${String(n).padStart(4,'0')}</span>`
              ).join('')}
            </div>
          </div>
          <a href="${waLink}" target="_blank"
            style="display:block;margin-top:14px;
              background:linear-gradient(135deg,#16A34A,#22C55E);
              color:#fff;font-weight:900;border-radius:12px;padding:12px;
              text-align:center;text-decoration:none;
              box-shadow:0 4px 20px rgba(34,197,94,.4);font-size:15px;">
            ğŸ“² Notificar ganador por WhatsApp
          </a>
        </div>`;
    }
  } catch(err) {
    console.error(err);
    resultDiv.innerHTML = `
      <div class="text-center text-red-400 text-sm py-3">
        âŒ Error al buscar. Intenta de nuevo.
      </div>`;
  } finally {
    btn.textContent = 'ğŸ” Buscar'; btn.disabled = false;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REINICIAR RIFA
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function reiniciarRifa() {
  const ok = confirm(
    'âš ï¸ Â¿EstÃ¡s seguro de que quieres REINICIAR la rifa?\n\n' +
    'Se borrarÃ¡n ABSOLUTAMENTE TODOS los pedidos y tickets.\n' +
    'Esta acciÃ³n NO se puede deshacer.'
  );
  if (!ok) return;
  const palabra = prompt('ğŸ”‘ Escribe exactamente la palabra de confirmaciÃ³n:\n\nKley');
  if (palabra === null) return;
  if (palabra !== 'Kley') { showToast('âŒ Palabra incorrecta. OperaciÃ³n cancelada.', 3500); return; }

  showToast('â³ Reiniciando base de datos...', 30000);
  try {
    const { error:e1 } = await db.from('tickets').delete().gte('numero',0);
    if (e1) throw e1;
    const { error:e2 } = await db.from('pedidos').delete()
      .in('estado',['pendiente','aprobado','rechazado']);
    if (e2) throw e2;
    alert('âœ… Â¡Rifa reiniciada exitosamente!\n\nTodos los tickets y pedidos fueron eliminados.\nLa pÃ¡gina se recargarÃ¡ ahora.');
    location.reload();
  } catch(err) {
    console.error('reiniciarRifa:', err);
    document.querySelector('.toast')?.remove();
    showToast('âŒ Error al reiniciar. Revisa la consola.', 5000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â˜… EDITAR PÃGINA PRINCIPAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleLandingPanel() {
  const panel = document.getElementById('landingEditPanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// Carga la config existente para pre-rellenar los campos
async function loadLandingConfig() {
  try {
    const { data } = await db.from('landing_config').select('*').eq('id','main').maybeSingle();
    if (data) {
      if (data.mensaje) document.getElementById('landingMsgInput').value = data.mensaje;
      if (data.flyer_url) {
        const prev = document.getElementById('flyerPreview');
        prev.src = data.flyer_url; prev.style.display = 'block';
        document.getElementById('flyerUploadText').textContent = 'Flyer actual (toca para cambiar)';
        document.getElementById('flyerUploadIcon').textContent = 'âœ…';
      }
    }
  } catch(e) { /* tabla aÃºn no existe, se crearÃ¡ al guardar */ }
}

function previewFlyer(input) {
  flyerFile = input.files[0];
  if (!flyerFile) return;
  const reader = new FileReader();
  reader.onload = e => {
    const prev = document.getElementById('flyerPreview');
    prev.src = e.target.result; prev.style.display = 'block';
    document.getElementById('flyerUploadIcon').textContent = 'âœ…';
    document.getElementById('flyerUploadText').textContent = flyerFile.name;
  };
  reader.readAsDataURL(flyerFile);
}

async function saveLandingContent() {
  const mensaje = document.getElementById('landingMsgInput').value.trim();
  let flyerUrl  = null;

  const saveBtn = document.querySelector('#landingEditPanel button[onclick="saveLandingContent()"]');
  saveBtn.textContent = 'â³ Guardando...'; saveBtn.disabled = true;

  try {
    // 1. Subir flyer si hay uno nuevo
    if (flyerFile) {
      const ext = flyerFile.name.split('.').pop();
      const path = `flyers/landing_${Date.now()}.${ext}`;
      const { error:upErr } = await db.storage.from('captures')
        .upload(path, flyerFile, { contentType:flyerFile.type, upsert:true });
      if (upErr) throw upErr;
      const { data:{ publicUrl } } = db.storage.from('captures').getPublicUrl(path);
      flyerUrl = publicUrl;
    }

    // 2. Upsert en landing_config
    const payload = { id:'main', mensaje };
    if (flyerUrl) payload.flyer_url = flyerUrl;

    const { error } = await db.from('landing_config')
      .upsert([payload], { onConflict:'id' });
    if (error) throw error;

    showToast('âœ… PÃ¡gina principal actualizada', 2500);
    toggleLandingPanel();
    flyerFile = null;
  } catch(err) {
    console.error('saveLandingContent:', err);
    showToast('âŒ Error al guardar. Verifica permisos de Supabase.', 3500);
  } finally {
    saveBtn.textContent = 'ğŸ’¾ Guardar cambios'; saveBtn.disabled = false;
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TOAST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, duration = 2500) {
  const ex = document.querySelector('.toast'); if (ex) ex.remove();
  const t = document.createElement('div');
  t.className = 'toast'; t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), duration);
}
</script>
</body>
</html>
